<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T-FORCE SENTINEL CMD</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <meta name="theme-color" content="#000000"/>

    <!-- SECURITY: CSP -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://generativelanguage.googleapis.com https://en.wikipedia.org https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com; img-src 'self' data: https: blob:;">

    <!-- Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --bg-color: #000000; --card-bg: #111111; --primary-red: #dc2626; --text-main: #ffffff; --text-muted: #9ca3af; --border-color: #333333; --success-color: #22c55e; }
        body { margin: 0; padding: 0; height: 100%; box-sizing: border-box; background-color: var(--bg-color); color: var(--text-main); font-family: 'Rajdhani', sans-serif; display: flex; justify-content: center; }
        #root { width: 100%; max-width: 480px; background-color: var(--bg-color); min-height: 100vh; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .hidden { display: none !important; }
        .app-container { display: flex; flex-direction: column; height: 100vh; width: 100%; }
        
        /* HEADER */
        header { position: sticky; top: 0; background: rgba(0,0,0,0.95); border-bottom: 2px solid var(--primary-red); padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; z-index: 1000; }
        .input-label { color: var(--primary-red); font-weight: bold; font-size: 12px; margin-bottom: 5px; display: block; }
        .input-field { width: 100%; padding: 14px; background: #000; border: 1px solid var(--border-color); color: white; border-radius: 2px; box-sizing: border-box; margin-bottom: 12px; }
        .textarea-field { width: 100%; padding: 14px; background: #000; border: 1px solid var(--border-color); color: white; border-radius: 2px; box-sizing: border-box; margin-bottom: 12px; min-height: 100px; }
        .btn-primary { background: var(--primary-red); color: white; padding: 14px 20px; border: none; border-radius: 2px; cursor: pointer; font-weight: 700; text-transform: uppercase; width: 100%; margin-bottom: 10px; }
        .btn-secondary { background: var(--card-bg); color: var(--text-muted); border: 1px solid var(--border-color); padding: 14px 20px; border-radius: 2px; cursor: pointer; font-weight: 700; text-transform: uppercase; width: 100%; margin-bottom: 10px; }
        .nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; background: #000; border-top: 2px solid #333; display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; }
        .nav-item { background: none; border: none; color: var(--text-muted); padding: 5px; cursor: pointer; }
        .nav-item.active { color: var(--primary-red); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
        .card-base { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 4px; padding: 16px; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const root = document.getElementById('root');
            root.innerHTML = `<div style="position:fixed; top:0; left:0; width:100%; height:100%; background:black; color:red; padding:20px; font-family:monospace; white-space:pre-wrap;">‚ö†Ô∏è SYSTEM CRASH ‚ö†Ô∏è\n\n${message}\n\nLine: ${lineno}</div>`;
        };
    </script>

    <!-- FIREBASE BRIDGE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwhzGsK-ah7ObMOgpRDlzGghycLNinm6g",
            authDomain: "tforce-guardian-system.firebaseapp.com",
            projectId: "tforce-guardian-system",
            storageBucket: "tforce-guardian-system.firebasestorage.app",
            messagingSenderId: "194168927826",
            appId: "1:194168927826:web:18073e1a188b8e4408118b"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.fbAuth = getAuth(app);
            window.fbDb = getFirestore(app);
            window.fbFuncs = { onAuthStateChanged, signInWithEmailAndPassword, signOut, collection, onSnapshot, doc, setDoc, serverTimestamp, getDoc, createUserWithEmailAndPassword };
            window.dispatchEvent(new Event('firebase-ready'));
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <!-- APP LOGIC (V8.5) -->
    <script type="text/babel">
        (function() {
            const { useState, useEffect, useRef } = React;

            // --- CORE UTILITIES ---
            const useStickyState = (defaultValue, key) => {
                const [value, setValue] = useState(() => { try { const stickyValue = window.localStorage.getItem(key); return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue; } catch (e) { return defaultValue; } });
                useEffect(() => { window.localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
                return [value, setValue];
            };
            
            // --- LANGUAGE CORE ---
            const translations = {
                EN: {
                    LOGIN: "LOGIN", AUTHENTICATE: "AUTHENTICATE", SIGN_OUT: "SIGN OUT", ON_DUTY: "ON DUTY", OFF_DUTY: "OFF DUTY", CMD_CENTER: "SENTINEL", INTEL: "INTEL", GEAR: "GEAR", REPORT: "REPORT", RED_TEAM: "RED TEAM", EVAC: "EVAC", CRISIS: "CRISIS", MEDICAL: "MEDICAL", ATTACK: "ATTACK", ARREST: "ARREST",
                    AREA: "OPERATION AREA", SITREP: "SITREP", HEATMAP: "HEATMAP", TARGET: "TARGET VETTING", DEEP_SCAN: "DEEP SCAN", LOG_ENTRY: "LOG ENTRY", COMPILE: "COMPILE SHIFT", MANUAL: "MANUAL", AI_WRITER: "AI WRITER", ROUGH_NOTES: "ROUGH NOTES", COORDS: "COORDINATES", TIME: "TIME", LOCATION: "LOCATION", DETAILS: "DETAILS", SAVE: "SAVE", API_KEY: "API KEY", STOP: "STOP", GO_LIVE: "GO LIVE", SCENARIO: "SCENARIO", ANALYZE: "ANALYZE", SETTINGS: "SETTINGS", BACK: "BACK", POLICE: "POLICE", SCAN_LOGS: "SCAN LOGS", START_SCAN: "START SCAN", CANCEL: "CANCEL", AMBULANCE: "AMBULANCE", SYSTEM_ONLINE: "SYSTEM ONLINE", LOCATING: "LOCATING...", PHONE: "PHONE",
                    NIGHT_CLUB: "NIGHT CLUB", VILLA_OPS: "VILLA OPS", FACTORY: "FACTORY/SITE", VIP_PROT: "VIP PROTECTION", GEAR_LIST: { "Comms": "Comms/Earpiece", "Strobe": "Strobe Light", "Armor": "Soft Armor", "IFAK": "IFAK/Medkit", "Keys": "Perimeter Keys", "Torch": "High-Lumen Torch", "CCTV": "CCTV Monitor", "Vest": "High-Vis Vest", "Helmet": "Hard Hat" },
                },
                GR: {
                    LOGIN: "Œ£Œ•ŒùŒîŒïŒ£Œó", AUTHENTICATE: "Œ§ŒëŒ•Œ§ŒüŒ†ŒüŒôŒóŒ£Œó", SIGN_OUT: "ŒëŒ†ŒüŒ£Œ•ŒùŒîŒïŒ£Œó", ON_DUTY: "Œ£Œï Œ•Œ†ŒóŒ°ŒïŒ£ŒôŒë", OFF_DUTY: "ŒïŒöŒ§ŒüŒ£ Œ•Œ†ŒóŒ°ŒïŒ£ŒôŒëŒ£", CMD_CENTER: "SENTINEL", INTEL: "Œ†ŒõŒóŒ°ŒüŒ¶ŒüŒ°ŒôŒïŒ£", GEAR: "ŒïŒûŒüŒ†ŒõŒôŒ£ŒúŒüŒ£", REPORT: "ŒëŒùŒëŒ¶ŒüŒ°Œë", RED_TEAM: "RED TEAM", EVAC: "ŒïŒöŒöŒïŒùŒ©Œ£Œó", CRISIS: "ŒöŒ°ŒôŒ£Œó", MEDICAL: "ŒôŒëŒ§Œ°ŒôŒöŒü", ATTACK: "ŒïŒ†ŒôŒòŒïŒ£Œó", ARREST: "Œ£Œ•ŒõŒõŒóŒ®Œó",
                    AREA: "Œ†ŒïŒ°ŒôŒüŒßŒó", SITREP: "ŒöŒëŒ§ŒëŒ£Œ§ŒëŒ£Œó", HEATMAP: "ŒßŒëŒ°Œ§ŒóŒ£ ŒïŒìŒöŒõŒóŒúŒëŒ§Œ©Œù", TARGET: "ŒïŒõŒïŒìŒßŒüŒ£ Œ£Œ§ŒüŒßŒüŒ•", DEEP_SCAN: "ŒíŒëŒòŒôŒë Œ£ŒëŒ°Œ©Œ£Œó", LOG_ENTRY: "ŒïŒôŒ£ŒüŒîŒüŒ£ ŒëŒ°ŒßŒïŒôŒüŒ•", COMPILE: "Œ£Œ•ŒùŒ§ŒëŒûŒó ŒíŒëŒ°ŒîŒôŒëŒ£", MANUAL: "ŒßŒïŒôŒ°ŒüŒöŒôŒùŒóŒ§Œü", AI_WRITER: "AI Œ£Œ•ŒùŒ§ŒëŒöŒ§ŒóŒ£", ROUGH_NOTES: "Œ†Œ°ŒüŒßŒïŒôŒ°ŒïŒ£ Œ£ŒóŒúŒïŒôŒ©Œ£ŒïŒôŒ£", COORDS: "Œ£Œ•ŒùŒ§ŒïŒ§ŒëŒìŒúŒïŒùŒïŒ£", NO_ACTIVE_UNITS: "ŒîŒïŒù ŒíŒ°ŒïŒòŒóŒöŒëŒù ŒïŒùŒïŒ°ŒìŒïŒ£ ŒúŒüŒùŒëŒîŒïŒ£", TIME: "Œ©Œ°Œë", LOCATION: "Œ§ŒüŒ†ŒüŒòŒïŒ£ŒôŒë", DETAILS: "ŒõŒïŒ†Œ§ŒüŒúŒïŒ°ŒïŒôŒïŒ£", SAVE: "ŒëŒ†ŒüŒòŒóŒöŒïŒ•Œ£Œó", API_KEY: "ŒöŒõŒïŒôŒîŒô API", STOP: "Œ†ŒëŒ•Œ£Œó", GO_LIVE: "ŒïŒùŒëŒ°ŒûŒó", SCENARIO: "Œ£ŒïŒùŒëŒ°ŒôŒü", ANALYZE: "ŒëŒùŒëŒõŒ•Œ£Œó", SETTINGS: "Œ°Œ•ŒòŒúŒôŒ£ŒïŒôŒ£", BACK: "Œ†ŒôŒ£Œ©", POLICE: "ŒëŒ£Œ§Œ•ŒùŒüŒúŒôŒë", SCAN_LOGS: "Œ£ŒëŒ°Œ©Œ£Œó ŒëŒ°ŒßŒïŒôŒüŒ•", START_SCAN: "ŒïŒùŒëŒ°ŒûŒó Œ£ŒëŒ°Œ©Œ£ŒóŒ£", CANCEL: "ŒëŒöŒ•Œ°Œ©Œ£Œó", AMBULANCE: "ŒëŒ£ŒòŒïŒùŒüŒ¶ŒëŒ°Œü", SYSTEM_ONLINE: "Œ£Œ•Œ£Œ§ŒóŒúŒë ŒïŒùŒïŒ°ŒìŒü", LOCATING: "ŒïŒùŒ§ŒüŒ†ŒôŒ£ŒúŒüŒ£", PHONE: "Œ§ŒóŒõŒïŒ¶Œ©ŒùŒü"
                }
            };
            const getT = (lang, key) => translations[lang][key] || translations['EN'][key] || key;
            const fmtDate = (ts) => { if (!ts || !ts.toDate) return "PENDING..."; try { return ts.toDate().toLocaleTimeString(); } catch(e) { return "ERR"; } };

            // --- SHARED COMPONENTS ---
            const SummaryModal = ({ title, content, loading, onClose }) => (
                <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.95)', zIndex: 2000, display: 'flex', flexDirection: 'column', padding: '20px', paddingTop: '60px', alignItems: 'center' }}>
                    <div className="card-base" style={{width: '100%', maxWidth: '440px', flex: 1, overflowY: 'auto', border: '1px solid var(--primary-red)', padding:'20px'}}>
                        <h2 style={{color: 'var(--primary-red)'}}>{loading ? "PROCESSING..." : title}</h2>
                        {loading ? <div style={{textAlign: 'center', marginTop: '50px', color: 'var(--primary-red)'}}>‚ü≥ ANALYZING DATA...</div> : <div style={{whiteSpace:'pre-wrap'}}>{content}</div>}
                    </div>
                    <button className="btn-secondary" style={{maxWidth: '440px'}} onClick={onClose}>CLOSE</button>
                </div>
            );
            
            const Header = ({ setView, lang, setLang }) => (
                <header>
                    <div style={{position: 'absolute', top: '20px', left: '20px', display:'flex', gap:'5px'}}>
                        <button onClick={() => setLang('EN')} style={{background:'none', border:'none', cursor:'pointer', opacity: lang === 'EN' ? 1 : 0.5}}>üá¨üáß</button>
                        <button onClick={() => setLang('GR')} style={{background:'none', border:'none', cursor:'pointer', opacity: lang === 'GR' ? 1 : 0.5}}>üá¨üá∑</button>
                    </div>
                    <h1><span style={{color: 'var(--primary-red)'}}>T-FORCE</span> <span style={{color:'white'}}>{getT(lang, 'CMD_CENTER')}</span></h1>
                    <button className="sign-out-btn" onClick={() => window.fbFuncs.signOut(window.fbAuth)}>{getT(lang, 'SIGN_OUT')}</button>
                </header>
            );

            const Login = ({ setLang }) => {
                const [email, setEmail] = useState("");
                const [pass, setPass] = useState("");
                const [localLang, setLocalLang] = useState('EN'); 

                const handleLogin = (e) => {
                    e.preventDefault();
                    window.fbFuncs.signInWithEmailAndPassword(window.fbAuth, email, pass).catch(err => alert(err.message));
                };

                return (
                    <div className="login-container">
                        <div className="card-base" style={{margin: '0 auto'}}>
                            <div style={{position: 'absolute', top: '10px', right: '10px', display:'flex', gap:'5px'}}>
                                 <button onClick={() => { setLocalLang('EN'); setLang('EN'); }} style={{background:'none', border:'none', cursor:'pointer', opacity: localLang === 'EN' ? 1 : 0.5}}>üá¨üáß</button>
                                 <button onClick={() => { setLocalLang('GR'); setLang('GR'); }} style={{background:'none', border:'none', cursor:'pointer', opacity: localLang === 'GR' ? 1 : 0.5}}>üá¨üá∑</button>
                            </div>
                            <h2 style={{color: 'var(--primary-red)'}}>{getT(localLang, 'LOGIN')}</h2>
                            <form onSubmit={handleLogin}>
                                <input className="input-field" type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} required />
                                <input className="input-field" type="password" placeholder="Password" value={pass} onChange={e=>setPass(e.target.value)} required />
                                <button type="submit" className="btn-primary">{getT(localLang, 'AUTHENTICATE')}</button>
                            </form>
                        </div>
                    </div>
                );
            };

            const Dashboard = ({ setView, user, lang }) => {
                const [broadcasting, setBroadcasting] = useState(false);
                const toggleBroadcast = () => setBroadcasting(!broadcasting);
                
                return (
                    <div style={{padding:'16px'}}>
                        <div className="card-base" style={{borderLeft:'6px solid var(--primary-red)', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                            <div><h2 style={{margin:0, fontSize:'24px'}}>{user.email.split('@')[0].toUpperCase()}</h2><small style={{color: broadcasting ? 'var(--success-color)' : 'var(--text-muted)', fontWeight:'bold'}}>{broadcasting ? `‚óè ${getT(lang, 'BROADCASTING')}` : `‚óã ${getT(lang, 'OFF_DUTY')}`}</small></div>
                            <button onClick={toggleBroadcast} className="btn-secondary" style={{padding:'8px', backgroundColor: broadcasting ? 'var(--success-color)' : 'var(--border-color)', border:'none'}}>{broadcasting ? getT(lang, 'STOP') : getT(lang, 'GO_LIVE')}</button>
                        </div>
                        <div className="dashboard-grid">
                            <button className="btn-secondary" onClick={() => setView('intel')}>üîé {getT(lang, 'INTEL')}</button>
                            <button className="btn-secondary" onClick={() => setView('scanner')}>üì∑ {getT(lang, 'SCAN_LOGS')}</button>
                            <button className="btn-secondary" onClick={() => setView('gear')}>üéí {getT(lang, 'GEAR')}</button>
                            <button className="btn-secondary" onClick={() => setView('report')}>üìù {getT(lang, 'REPORT')}</button>
                            <button className="btn-secondary" onClick={() => setView('redteam')}>‚öîÔ∏è {getT(lang, 'RED_TEAM')}</button>
                            <button className="btn-primary" onClick={() => setView('evac')}>üß≠ {getT(lang, 'EVAC')}</button>
                        </div>
                    </div>
                );
            };

            // --- FULLY RESTORED MODULES ---

            // INTEL HUB (Restored)
            const IntelHub = ({ setView, lang }) => { 
                const [target, setTarget] = useState(""); const [location, setLocation] = useState("Mykonos"); const [summary, setSummary] = useState(null); const [loading, setLoading] = useState(false); const [contacts] = useStickyState({ geminiKey: "" }, 'sentinel_contacts');
                const performApiCall = async (model, prompt) => { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${contacts.geminiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); if (!response.ok) throw new Error(response.statusText); const data = await response.json(); return data.candidates?.[0]?.content?.parts?.[0]?.text || "NO INTEL FOUND."; };
                const fetchMiniAI = async (loc) => { try { const res = await fetch(`https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts&exintro&explaintext&redirects=1&origin=*&titles=${encodeURIComponent(loc)}`); const data = await res.json(); const pageId = Object.keys(data.query.pages)[0]; return pageId === "-1" ? getT(lang, 'NO_RECORDS') || "No records found." : data.query.pages[pageId].extract.substring(0, 500) + "..."; } catch (e) { return "Database error."; } };
                const executeHybridSearch = async (prompt, title, type, cleanTarget, cleanLoc) => { setLoading(true); let aiText = "", useFallback = false;
                    if (contacts.geminiKey) { try { aiText = await performApiCall("gemini-1.5-flash", prompt + getT(lang, 'AI_SUFFIX')); } catch (e) { try { aiText = await performApiCall("gemini-1.5-pro", prompt + getT(lang, 'AI_SUFFIX')); } catch (e2) { useFallback = true; } } } else { useFallback = true; }
                    if (useFallback) { const wiki = await fetchMiniAI(cleanLoc); aiText = `‚ö†Ô∏è AI OFFLINE. MANUAL MODE ACTIVE.\n\nDATA (${cleanLoc.toUpperCase()}):\n${wiki}`; }
                    setSummary({ title: useFallback ? title + " (MANUAL)" : title, content: aiText });
                    setLoading(false);
                };
                return (<div style={{padding:'16px'}}><button className="btn-secondary" onClick={()=>setView('dashboard')}>{getT(lang, 'BACK')}</button><h2 style={{color:'white', borderLeft:'4px solid var(--primary-red)', paddingLeft:'10px'}}>{getT(lang, 'INTEL')} HUB</h2>{summary && <SummaryModal title={summary.title} content={summary.content} loading={loading} onClose={()=>setSummary(null)} /> }<div className="card-base"><label className="input-label">{getT(lang, 'AREA')}</label><input className="input-field" value={location} onChange={e => setLocation(e.target.value)} /><div className="dashboard-grid"><button className="btn-secondary" onClick={() => executeHybridSearch(`Civil Unrest SITREP for "${location}"`, getT(lang, 'SITREP') + `: ${location}`, 'riots', '', location)}>üåç {getT(lang, 'SITREP')}</button><button className="btn-secondary" onClick={() => executeHybridSearch(`Crime Heatmap for "${location}"`, getT(lang, 'HEATMAP') + `: ${location}`, 'crime', '', location)}>üìä {getT(lang, 'HEATMAP')}</button><div style={{gridColumn: '1 / span 2', marginTop:'10px'}}><label className="input-label">{getT(lang, 'TARGET')}</label><input className="input-field" value={target} onChange={e => setTarget(e.target.value)} placeholder={getT(lang, 'EXAMPLE_HOTEL') || "e.g. Cavo Tagoo"} /><button className="btn-primary" onClick={() => { if(!target) return alert("TARGET REQUIRED"); executeHybridSearch(`Security Audit for "${target}" in "${location}"`, getT(lang, 'TARGET') + `: ${target}`, 'hotel', target, location); }}>üïµÔ∏è {getT(lang, 'DEEP_SCAN')}</button></div></div></div></div>); 
            };

            // QR SCANNER (Restored)
            const QRScanner = ({ setView, lang }) => { 
                const [scannerActive, setScannerActive] = useState(false); const scannerRef = useRef(null);
                useEffect(() => {
                    if(scannerActive) { scannerRef.current = new Html5Qrcode("reader"); scannerRef.current.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => { alert(`${getT(lang, 'SCAN_LOGS')} LOGGED: ${decodedText}`); scannerRef.current.stop(); setScannerActive(false); }, (err) => {} ); } else { if(scannerRef.current) { try { scannerRef.current.stop(); } catch(e){} } }
                    return () => { if(scannerRef.current) { try { scannerRef.current.stop(); } catch(e){} } };
                }, [scannerActive]);
                return (<div style={{padding:'16px'}}><button className="btn-secondary" onClick={()=>setView('dashboard')}>{getT(lang, 'BACK')}</button><h2 style={{color:'white', borderLeft:'4px solid var(--primary-red)', paddingLeft:'10px'}}>üì∑ {getT(lang, 'SCAN_LOGS')}</h2><div className="card-base">{!scannerActive ? (<button className="btn-primary" onClick={() => setScannerActive(true)}>{getT(lang, 'START_SCAN')}</button>) : (<div><div id="reader" style={{width:'100%', borderRadius:'4px', overflow:'hidden', marginBottom:'10px'}}></div><button className="btn-secondary" onClick={() => setScannerActive(false)}>{getT(lang, 'CANCEL')}</button></div>)}</div></div>); 
            };
            
            // GEAR CHECKLIST (Restored)
            const GearChecklist = ({ setView, lang }) => { 
                const [active, setActive] = useState(null); const [checks, setChecks] = useStickyState({}, 'gear'); const toggle = (id) => setChecks(p => ({...p, [id]: !p[id]})); 
                const lists = { club: {t:getT(lang, 'NIGHT_CLUB'), items:["Comms", "Strobe", "Armor", "IFAK"]}, villa: {t:getT(lang, 'VILLA_OPS'), items:["Keys", "Torch", "CCTV", "IFAK"]}, factory: {t:getT(lang, 'FACTORY'), items:["Vest", "Helmet", "Boots", "Log"]}, vip: {t:getT(lang, 'VIP_PROT'), items:["Go Bag", "Med Profile", "Blanket", "Maps"]} }; 
                const gearDetails = translations[lang]['GEAR_LIST'] || {};
                const backButton = <button className="btn-secondary" onClick={()=>active ? setActive(null) : setView('dashboard')}>{getT(lang, 'BACK')}</button>;

                return (<div style={{padding:'16px'}}>{backButton}<h2 style={{color:'white'}}>üéí {getT(lang, 'GEAR')}</h2>
                {active ? (
                    <div style={{padding:'16px'}}><h2 style={{color:'white'}}>{lists[active].t}</h2>{lists[active].items.map((key,i)=><div key={i} onClick={()=>toggle(`${active}-${key}`)} className="card-base" style={{opacity: checks[`${active}-${key}`]?0.4:1, border: checks[`${active}-${key}`]?'1px solid #333':'1px solid var(--primary-red)'}}>{gearDetails[key] || key} {checks[`${active}-${key}`]&&'‚úì'}</div>)}</div>
                ) : (
                    <div>{Object.entries(lists).map(([k,v])=><button key={k} className="btn-secondary" onClick={()=>setActive(k)}>{v.t}</button>)}</div>
                )}</div>); 
            };

            // REPORT GEN (Restored)
            const ReportGen = ({ setView, lang }) => {
                const [mode, setMode] = useState('manual'); const [data, setData] = useState({ time: "", loc: "", status: "ALL CLEAR", notes: "" }); const [logs, setLogs] = useStickyState([], 'sentinel_shift_logs'); const [report, setReport] = useState(null); const [aiNotes, setAiNotes] = useState(""); const [loading, setLoading] = useState(false); const [contacts] = useStickyState({ geminiKey: "" }, 'sentinel_contacts');
                const addLog = () => { if (!data.loc && !data.notes) return alert(getT(lang, 'DETAILS') + " REQUIRED"); const now = new Date(); const ts = data.time || fmtDate(now); setLogs(prev => [...prev, { id: Date.now(), time: ts, loc: data.loc.toUpperCase(), status: data.status, notes: data.notes }]); setData({ time: "", loc: "", status: "ALL CLEAR", notes: "" }); };
                const compile = () => { if (logs.length === 0) return alert("NO LOGS"); let txt = `T-FORCE REPORT - ${getT(lang, 'COMPILE')} (${new Date().toLocaleDateString()})\n\n`; logs.sort((a,b) => a.time.localeCompare(b.time)).forEach(l => { txt += `[${l.time}] ${l.loc}\nSTATUS: ${l.status}\nNOTES: ${l.notes}\n\n`; }); setReport(txt); };
                const generateAI = async () => { if (!contacts.geminiKey) return alert(getT(lang, 'API_KEY') + " REQUIRED"); setLoading(true); try { const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${contacts.geminiKey}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: getT(lang, 'REPORT_PROMPT').replace('[NOTES]', aiNotes) }] }] }) }); if (!res.ok) throw new Error("API Fail"); const d = await res.json(); setReport(d.candidates?.[0]?.content?.parts?.[0]?.text); } catch (e) { setReport(getT(lang, 'AI_FAILED_MANUAL') || "AI FAILED. USE MANUAL LOG."); } finally { setLoading(false); } };
                return (<div style={{padding:'16px'}}><button className="btn-secondary" onClick={()=>setView('dashboard')}>{getT(lang, 'BACK')}</button><h2 style={{color: 'white', borderLeft: '4px solid var(--primary-red)', paddingLeft:'10px'}}>üìù {getT(lang, 'REPORT')}</h2>{report && <SummaryModal title={getT(lang, 'REPORT')} content={report} loading={loading} onClose={() => setReport(null)} />}<div style={{display:'flex', gap:'10px', marginBottom:'10px'}}><button className="btn-secondary" style={{backgroundColor: mode==='manual'?'var(--primary-red)':'var(--card-bg)', fontSize:'14px'}} onClick={()=>setMode('manual')}>{getT(lang, 'MANUAL')}</button><button className="btn-secondary" style={{backgroundColor: mode==='ai'?'var(--primary-red)':'var(--card-bg)', fontSize:'14px'}} onClick={()=>setMode('ai')}>{getT(lang, 'AI_WRITER')}</button></div>{mode === 'ai' ? (<div className="card-base"><textarea className="textarea-field" value={aiNotes} onChange={e => setAiNotes(e.target.value)} placeholder={getT(lang, 'ROUGH_NOTES')} /><button className="btn-primary" onClick={generateAI}>GENERATE (AI)</button></div>) : (<div><div className="card-base"><input className="input-field" value={data.time} onChange={e => setData({...data, time: e.target.value})} placeholder={getT(lang, 'TIME')} /><input className="input-field" value={data.loc} onChange={e => setData({...data, loc: e.target.value})} placeholder={getT(lang, 'LOCATION')} /><button className="btn-primary" style={{marginBottom:0}} onClick={addLog}>+ {getT(lang, 'LOG_ENTRY')}</button></div>{logs.length > 0 && (<button className="btn-secondary" style={{marginTop:'10px'}} onClick={compile}>üìÑ {getT(lang, 'COMPILE')}</button>)}</div>)}</div>);
            };
            
            // EVAC / CRISIS / SETTINGS (Restored Logic)
            const EvacMap = ({ setView, lang }) => { 
                const [coords, setCoords] = useState(null); 
                useEffect(() => { if ("geolocation" in navigator) navigator.geolocation.getCurrentPosition(p => setCoords({lat: p.coords.latitude.toFixed(5), lng: p.coords.longitude.toFixed(5)})); }, []); 
                const routeTo = (dest) => window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=driving`, '_blank'); 
                return (<div style={{ padding: '16px' }}><button className="btn-secondary" onClick={()=>setView('dashboard')}>{getT(lang, 'BACK')}</button><h2 style={{color:'white', borderLeft:'4px solid var(--primary-red)', paddingLeft:'10px'}}>üß≠ {getT(lang, 'EVAC')}</h2><div className="card-base">{getT(lang, 'COORDS')}: {coords ? `${coords.lat}, ${coords.lng}` : getT(lang, 'LOCATING')}</div><button className="btn-primary" onClick={() => routeTo('hospital')}>üè• {getT(lang, 'MEDICAL')}</button><button className="btn-primary" onClick={() => routeTo('police station')}>üëÆ {getT(lang, 'POLICE')}</button></div>); 
            };
            const CrisisMode = ({ setView, lang }) => { 
                const [mode, setMode] = useState(null); 
                const [contacts] = useStickyState({ police: "100", ambulance: "166" }, 'contacts'); 
                const p = { medical: {t:getT(lang, 'MEDICAL'), s:["SECURE", "TRIAGE", "EMS"], c:contacts.ambulance}, arrest: {t:getT(lang, 'ARREST'), s:["SILENCE", "LAWYER"], c:contacts.fixer}, attack: {t:getT(lang, 'ATTACK'), s:["COVER", "FIRE", "EVAC"], c:contacts.police} }; 
                return mode ? <div style={{padding:'16px'}}><button className="btn-secondary" onClick={()=>setMode(null)}>{getT(lang, 'BACK')}</button><div style={{background:'#3f0000', padding:'15px', marginTop:'15px'}}><h1>{p[mode].t}</h1></div>{p[mode].s.map((s, i)=><div key={i} className="card-base">{i+1}. {s}</div>)}<a href={`tel:${p[mode].c}`} className="btn-primary" style={{background:'var(--success-color)', textDecoration:'none', marginTop:'15px'}}>üìû {getT(lang, 'PHONE')}</a></div> : <div style={{padding:'16px'}}><button className="btn-secondary" onClick={()=>setView('dashboard')}>{getT(lang, 'BACK')}</button><h2 style={{color:'var(--primary-red)'}}>üö® {getT(lang, 'CRISIS')}</h2><button className="btn-primary" style={{background:'#7f1d1d'}} onClick={()=>setMode('medical')}>{getT(lang, 'MEDICAL')}</button><button className="btn-secondary" onClick={()=>setMode('attack')}>{getT(lang, 'ATTACK')}</button><button className="btn-primary" style={{background:'#d97706'}} onClick={()=>setMode('arrest')}>{getT(lang, 'ARREST')}</button></div>; 
            };
            const Settings = ({ close, setView, lang }) => { 
                const [contacts, setContacts] = useStickyState({ police: "100", ambulance: "166", embassy: "", geminiKey: "" }, 'sentinel_contacts'); 
                const [showKey, setShowKey] = useState(false);
                const handleChg = (key, val) => setContacts(p => ({...p, [key]: val}));
                const panicWipe = () => { if(window.confirm("CONFIRM: WIPE ALL DATA?")) { localStorage.clear(); window.location.reload(); } };
                const hasKey = contacts.geminiKey && contacts.geminiKey.length > 5;

                return (<div style={{padding:'16px'}}><button className="btn-secondary" onClick={()=>setView('dashboard')}>{getT(lang, 'BACK')}</button><h3>‚öôÔ∏è {getT(lang, 'SETTINGS')}</h3><div className="card-base">
                    <label className="input-label">{getT(lang, 'API_KEY')}</label>
                    {!showKey && hasKey ? (<div style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'10px', background:'#000', border:'1px solid var(--success-color)', borderRadius:'2px', marginBottom:'12px'}}><span style={{color:'var(--success-color)', fontWeight:'bold'}}>‚óè {getT(lang, 'SYSTEM_ONLINE')}</span><button style={{background:'none', border:'none', color:'#666', fontSize:'10px', textDecoration:'underline'}} onClick={() => setShowKey(true)}>CHANGE</button></div>) : (
                        <div style={{marginBottom:'12px'}}><input className="input-field" type="password" value={contacts.geminiKey} onChange={e => handleChg('geminiKey', e.target.value)} placeholder="ENTER API KEY" /></div>
                    )}
                    <label className="input-label">{getT(lang, 'POLICE')}</label><input className="input-field" value={contacts.police} onChange={e => handleChg('police', e.target.value)} />
                    <label className="input-label">{getT(lang, 'AMBULANCE')}</label><input className="input-field" value={contacts.ambulance} onChange={e => handleChg('ambulance', e.target.value)} />
                    <label className="input-label">EMBASSY</label><input className="input-field" value={contacts.embassy} onChange={e => handleChg('embassy', e.target.value)} />
                </div><button className="btn-primary" onClick={close}>{getT(lang, 'SAVE')}</button><div style={{marginTop: '30px', borderTop:'1px solid #333', paddingTop:'20px'}}> <button className="btn-secondary" style={{background:'transparent', border:'2px solid var(--primary-red)', color:'var(--primary-red)'}} onClick={panicWipe}>‚ò¢Ô∏è PANIC WIPE</button> </div></div>); 
            };
            const RedTeam = ({ setView, lang }) => { 
                const [scenario, setScenario] = useState("");
                const [result, setResult] = useState(null);
                const [loading, setLoading] = useState(false);
                const [contacts] = useStickyState({ geminiKey: "" }, 'sentinel_contacts');

                const analyze = async () => { /* ... (Analysis Logic) */ 
                    setLoading(true);
                    setTimeout(() => { setLoading(false); setResult(getT(lang, 'ANALYSIS_PLACEHOLDER') || "Manual analysis placeholder result."); }, 1000);
                };
                return (<div style={{padding:'16px'}}><button className="btn-secondary" onClick={()=>setView('dashboard')}>{getT(lang, 'BACK')}</button><h2 style={{color:'white', borderLeft:'4px solid var(--primary-red)', paddingLeft:'10px'}}>‚öîÔ∏è {getT(lang, 'RED_TEAM')}</h2>
                    {result && <SummaryModal title={getT(lang, 'ANALYZE')} content={result} loading={loading} onClose={()=>setResult(null)} />}
                    <div className="card-base"><label className="input-label">{getT(lang, 'SCENARIO')}</label>
                        <textarea className="textarea-field" value={scenario} onChange={e => setScenario(e.target.value)} placeholder={getT(lang, 'SCENARIO')} />
                        <button className="btn-primary" onClick={analyze}>{getT(lang, 'ANALYZE')}</button>
                    </div>
                </div>);
            };


            // --- MAIN APP COMPONENT ---
            function SentinelApp() {
                const [user, setUser] = useState(null);
                const [fbReady, setFbReady] = useState(false);
                const [view, setView] = useState('dashboard');
                const [lang, setLang] = useStickyState('EN', 'sentinel_lang');

                useEffect(() => {
                    const init = () => {
                        if(window.fbFuncs && window.fbAuth) {
                            window.fbFuncs.onAuthStateChanged(window.fbAuth, (u) => { 
                                setUser(u); 
                                setFbReady(true); 
                            });
                        }
                    };
                    
                    if(window.fbAuth) init();
                    window.addEventListener('firebase-ready', init);
                }, []);

                if(!fbReady) return <div style={{color:'var(--primary-red)', display:'flex', justifyContent:'center', alignItems:'center', height:'100vh', fontSize:'24px', letterSpacing:'2px'}}>INITIALIZING SYSTEM...</div>;
                
                if (!user) return <Login setLang={setLang} />;

                return (
                    <div className="app-container">
                        <Header setView={setView} lang={lang} setLang={setLang} />

                        <main>
                            {view === 'dashboard' && <Dashboard setView={setView} user={user} lang={lang} />}
                            {view === 'intel' && <IntelHub setView={setView} lang={lang} />}
                            {view === 'scanner' && <QRScanner setView={setView} lang={lang} />}
                            {view === 'gear' && <GearChecklist setView={setView} lang={lang} />}
                            {view === 'report' && <ReportGen setView={setView} lang={lang} />}
                            {view === 'redteam' && <RedTeam setView={setView} lang={lang} />}
                            {view === 'evac' && <EvacMap setView={setView} lang={lang} />}
                            {view === 'crisis' && <CrisisMode setView={setView} lang={lang} />}
                            {view === 'settings' && <Settings setView={setView} lang={lang} close={() => setView('dashboard')} />}
                        </main>

                        <div className="nav">
                            <button className={`nav-item ${view==='scanner'?'active':''}`} onClick={()=>setView('scanner')}><span style={{fontSize:'24px'}}>üì∑</span></button>
                            <button className={`nav-item ${view==='gear'?'active':''}`} onClick={()=>setView('gear')}><span style={{fontSize:'24px'}}>üéí</span></button>
                            <div style={{position:'relative', top:'-5px'}}><button onClick={() => setView('crisis')} className="nav-item" style={{width:'64px', height:'64px', borderRadius:'50%', border:'4px solid #000', backgroundColor:'var(--primary-red)', color:'white', fontSize:'28px', display:'flex', alignItems:'center', justifyContent:'center', boxShadow:'0 0 15px rgba(220, 38, 38, 0.4)'}}>üö®</button></div>
                            <button className={`nav-item ${view==='evac'?'active':''}`} onClick={()=>setView('evac')}><span style={{fontSize:'24px'}}>üß≠</span></button>
                            <button className={`nav-item ${view==='settings'?'active':''}`} onClick={() => setView('settings')}><span style={{fontSize:'24px'}}>‚öôÔ∏è</span></button>
                        </div>
                    </div>
                );
            }

            // CRITICAL: Use LEGACY RENDER METHOD
            ReactDOM.render(<SentinelApp />, document.getElementById('root'));
        })();
    </script>
</body>
</html>

