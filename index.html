<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <!-- SECURITY: CSP -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.tailwindcss.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://generativelanguage.googleapis.com https://en.wikipedia.org https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com; img-src 'self' data: https: blob:;">
    
    <title>T-FORCE SENTINEL CMD</title>

    <!-- Font: Rajdhani -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

    <!-- Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root { --bg-color: #000000; --card-bg: #111111; --text-main: #ffffff; --text-muted: #9ca3af; --brand-red: #dc2626; --border-color: #27272a; }
        body { margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-main); user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Rajdhani', sans-serif; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--brand-red); }
        .ai-content strong { color: var(--brand-red); }
        .ai-content ul { padding-left: 20px; color: var(--text-muted); }
        #crash-screen { display: none; padding: 20px; color: red; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="crash-screen"></div>

    <!-- FIREBASE BRIDGE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection, serverTimestamp, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwhzGsK-ah7ObMOgpRDlzGghycLNinm6g",
            authDomain: "tforce-guardian-system.firebaseapp.com",
            projectId: "tforce-guardian-system",
            storageBucket: "tforce-guardian-system.firebasestorage.app",
            messagingSenderId: "194168927826",
            appId: "1:194168927826:web:18073e1a188b8e4408118b",
            measurementId: "G-QEX7FFSNKG"
        };

        const app = initializeApp(firebaseConfig);
        window.fbAuth = getAuth(app);
        window.fbDb = getFirestore(app);
        window.fbFunctions = { onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, doc, setDoc, getDoc, addDoc, collection, serverTimestamp, deleteDoc, onSnapshot };
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            const crash = document.getElementById('crash-screen');
            crash.style.display = 'block';
            crash.innerHTML = "‚ö†Ô∏è SYSTEM CRASH ‚ö†Ô∏è\n\n" + message + "\n\nLine: " + lineno;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- STYLES ---
        const styles = {
          app: { fontFamily: "'Rajdhani', sans-serif", backgroundColor: '#000000', color: '#ffffff', minHeight: '100vh', paddingBottom: '90px', maxWidth: '100%', margin: '0 auto', overflowX: 'hidden' },
          header: { position: 'sticky', top: 0, backgroundColor: 'rgba(0, 0, 0, 0.95)', backdropFilter: 'blur(10px)', borderBottom: '2px solid #dc2626', padding: '12px 16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', zIndex: 1000 },
          card: { backgroundColor: '#111111', border: '1px solid #333333', borderRadius: '4px', padding: '16px', marginBottom: '16px', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.5)' },
          btnBase: { width: '100%', padding: '16px', border: 'none', borderRadius: '2px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '1px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '10px', fontSize: '18px', marginBottom: '10px', transition: 'all 0.1s' },
          btnPrimary: { backgroundColor: '#dc2626', color: 'white', boxShadow: '0 0 10px rgba(220, 38, 38, 0.3)' },
          btnSecondary: { backgroundColor: '#1f1f1f', color: '#e5e7eb', border: '1px solid #333' },
          input: { width: '100%', padding: '14px', backgroundColor: '#000000', border: '1px solid #333', color: 'white', borderRadius: '2px', marginBottom: '12px', fontSize: '16px', fontFamily: "'Rajdhani', sans-serif" },
          textarea: { width: '100%', padding: '14px', backgroundColor: '#000000', border: '1px solid #333', color: 'white', borderRadius: '2px', marginBottom: '12px', fontSize: '16px', fontFamily: "'Rajdhani', sans-serif", minHeight: '100px' },
          nav: { position: 'fixed', bottom: 0, left: 0, right: 0, backgroundColor: '#000000', borderTop: '2px solid #333', display: 'flex', justifyContent: 'space-around', padding: '12px 10px', zIndex: 1000, paddingBottom: '20px' },
          navItem: { background: 'none', border: 'none', color: '#6b7280', fontSize: '10px', display: 'flex', flexDirection: 'column', alignItems: 'center', fontFamily: "'Rajdhani', sans-serif", fontWeight: '600' },
          logoText: { fontWeight: 'bold', fontSize: '22px', letterSpacing: '1px', display: 'flex', alignItems: 'center', gap: '8px' }
        };

        const useStickyState = (defaultValue, key) => {
          const [value, setValue] = useState(() => { try { const stickyValue = window.localStorage.getItem(key); return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue; } catch (e) { return defaultValue; } });
          useEffect(() => { window.localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
          return [value, setValue];
        };

        // --- HEADER (RESTORED) ---
        const Header = ({ setView }) => (
          <div style={styles.header}>
            <div onClick={() => setView('dashboard')} style={styles.logoText}>
              <img src="./Tforcelogo1(1).png" alt="T-FORCE" style={{height: '35px', objectFit: 'contain'}} onError={(e) => {e.target.style.display='none'; document.getElementById('fallback-logo').style.display='block'}} />
              <div id="fallback-logo" style={{display: 'none'}}><span style={{color:'white'}}>T-FORCE</span><span style={{color:'#dc2626'}}>SEC</span></div>
            </div>
            <div onClick={() => setView('settings')} style={{ fontSize: '24px', color: '#dc2626' }}>‚öôÔ∏è</div>
          </div>
        );

        // --- AUTH ---
        const AuthScreen = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [username, setUsername] = useState("");
            const [error, setError] = useState("");
            const [loading, setLoading] = useState(false);

            const handleAuth = async () => {
                setLoading(true); setError("");
                const { signInWithEmailAndPassword, createUserWithEmailAndPassword, setDoc, doc, serverTimestamp } = window.fbFunctions;
                try {
                    if (isLogin) { await signInWithEmailAndPassword(window.fbAuth, email, password); } 
                    else {
                        const cred = await createUserWithEmailAndPassword(window.fbAuth, email, password);
                        await setDoc(doc(window.fbDb, 'users', cred.user.uid), { username: username, email: email, createdAt: serverTimestamp(), emergencyContact: "" });
                    }
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };

            return (
                <div style={{...styles.app, display:'flex', flexDirection:'column', justifyContent:'center', padding:'20px'}}>
                    <div style={{textAlign:'center', marginBottom:'40px'}}>
                        <img src="./Tforcelogo1(1).png" style={{height:'80px', marginBottom:'20px'}} onError={(e) => e.target.style.display='none'} />
                        <h1 style={{color:'#dc2626', fontSize:'32px', margin:0}}>T-FORCE</h1>
                        <h2 style={{color:'white', fontSize:'24px', margin:0}}>GUARDIAN SYSTEM</h2>
                    </div>
                    <div style={styles.card}>
                        <h3 style={{color:'white', marginTop:0}}>{isLogin ? "LOGIN" : "NEW PROFILE"}</h3>
                        {!isLogin && <input style={styles.input} placeholder="Full Name" value={username} onChange={e=>setUsername(e.target.value)} />}
                        <input style={styles.input} type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} />
                        <input style={styles.input} type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} />
                        {error && <p style={{color:'red', fontSize:'12px'}}>{error}</p>}
                        <button style={{...styles.btnBase, ...styles.btnPrimary}} onClick={handleAuth} disabled={loading}>{loading ? "PROCESSING..." : (isLogin ? "ENTER" : "CREATE")}</button>
                        <p style={{textAlign:'center', color:'#999', fontSize:'12px', marginTop:'10px'}} onClick={() => setIsLogin(!isLogin)}>{isLogin ? "New Guardian? Create Account" : "Have an account? Login"}</p>
                    </div>
                </div>
            );
        };

        // --- SHARED MODAL ---
        const SummaryModal = ({ title, content, links, loading, onClose }) => (
            <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.95)', zIndex: 2000, display: 'flex', flexDirection: 'column', padding: '20px', paddingTop: '60px' }}>
                <div style={{...styles.card, flex: 1, overflowY: 'auto', border: '1px solid #dc2626'}}>
                    <h2 style={{color: '#dc2626', marginTop: 0, borderBottom: '1px solid #333', paddingBottom: '10px'}}>{loading ? "PROCESSING..." : title}</h2>
                    {loading ? <div style={{textAlign: 'center', marginTop: '50px', color: '#dc2626'}}>‚ü≥ ANALYZING DATA...</div> : (
                        <div className="ai-content" style={{lineHeight: '1.6', fontSize: '16px', whiteSpace: 'pre-wrap'}}>
                            {content}
                            {links && links.length > 0 && (
                                <div style={{marginTop: '20px', paddingTop: '20px', borderTop: '1px solid #333'}}>
                                    <h4 style={{color: '#dc2626', margin: '0 0 10px 0'}}>EXTERNAL LINKS</h4>
                                    {links.map((link, i) => <button key={i} style={{...styles.btnBase, backgroundColor: '#333', fontSize: '14px', height: 'auto', padding: '12px'}} onClick={() => window.open(link.url, '_blank')}>üîó {link.label}</button>)}
                                </div>
                            )}
                        </div>
                    )}
                </div>
                <button style={{...styles.btnBase, ...styles.btnSecondary}} onClick={onClose}>CLOSE</button>
            </div>
        );

        // --- QR SCANNER ---
        const QRScanner = () => {
            useEffect(() => {
                const scanner = new Html5Qrcode("reader");
                scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
                    (decodedText) => {
                        alert("CHECKPOINT LOGGED: " + decodedText);
                        scanner.stop();
                        // Add log logic here if needed
                    }, (err) => {}
                );
                return () => { try { scanner.stop(); } catch(e){} };
            }, []);
            return (<div style={{padding:'16px'}}><h2 style={{color:'white'}}>CHECKPOINT SCANNER</h2><div id="reader" style={{width:'100%', borderRadius:'8px', overflow:'hidden'}}></div></div>);
        };

        // --- INTEL HUB (Hybrid V6.4) ---
        const IntelHub = () => {
            const [target, setTarget] = useState("");
            const [location, setLocation] = useState("Mykonos");
            const [summary, setSummary] = useState(null);
            const [loading, setLoading] = useState(false);
            const [contacts] = useStickyState({ geminiKey: "" }, 'sentinel_contacts');

            const performApiCall = async (model, prompt) => {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${contacts.geminiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Role: T-Force Security Analyst. Output: Tactical Summary. No fluff. QUERY: ${prompt}` }] }] })
                });
                if (!response.ok) throw new Error(response.statusText);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text;
            };

            const fetchMiniAI = async (loc) => {
                try {
                    const res = await fetch(`https://en.wikipedia.org/w/api.php?format=json&action=query&prop=extracts&exintro&explaintext&redirects=1&origin=*&titles=${encodeURIComponent(loc)}`);
                    const data = await res.json();
                    const pageId = Object.keys(data.query.pages)[0];
                    return pageId === "-1" ? "No records found." : data.query.pages[pageId].extract.substring(0, 500) + "...";
                } catch (e) { return "Database error."; }
            };

            const executeHybridSearch = async (prompt, title, type, cleanTarget, cleanLoc) => {
                setLoading(true);
                setSummary({ title, content: "", links: [] });
                let aiText = "", useFallback = false;

                if (contacts.geminiKey) {
                    try { aiText = await performApiCall("gemini-1.5-flash", prompt); }
                    catch (e) { try { aiText = await performApiCall("gemini-1.5-pro", prompt); } catch (e2) { useFallback = true; } }
                } else { useFallback = true; }

                if (useFallback) {
                    const wiki = await fetchMiniAI(cleanLoc);
                    aiText = `‚ö†Ô∏è AI OFFLINE. MANUAL MODE ACTIVE.\n\nDATA (${cleanLoc.toUpperCase()}):\n${wiki}`;
                }

                const smartLinks = type === 'hotel' ? [
                    { label: "Deep Search: 'Theft/Scams'", url: `https://www.google.com/search?q=${encodeURIComponent(`site:tripadvisor.com "${cleanTarget}" theft unsafe scam`)}` },
                    { label: "Booking Reviews", url: `https://www.google.com/search?q=${encodeURIComponent(`site:booking.com "${cleanTarget}" negative review`)}` }
                ] : [
                    { label: "Live: Twitter/X", url: `https://www.google.com/search?q=${encodeURIComponent(`site:twitter.com "${cleanLoc}" riot protest crime`)}` },
                    { label: "Local News", url: `https://www.google.com/search?q=${encodeURIComponent(`${cleanLoc} news crime protest`)}` }
                ];
                setSummary({ title: useFallback ? title + " (MANUAL)" : title, content: aiText, links: smartLinks });
                setLoading(false);
            };

            return (
                <div style={{padding:'16px'}}>
                    <h2 style={{color:'white', borderLeft:'4px solid #dc2626', paddingLeft:'10px'}}>INTEL HUB (OSINT)</h2>
                    {summary && <SummaryModal title={summary.title} content={summary.content} links={summary.links} loading={loading} onClose={() => setSummary(null)} />}
                    <div style={styles.card}>
                        <label style={{fontSize:'12px', color:'#dc2626'}}>AREA</label>
                        <input style={styles.input} value={location} onChange={e => setLocation(e.target.value)} />
                        <div style={{display:'flex', gap:'8px'}}>
                            <button style={{...styles.btnBase, ...styles.btnSecondary}} onClick={() => executeHybridSearch(`Civil Unrest SITREP for "${location}"`, `SITREP: ${location}`, 'riots', '', location)}>üåç SITREP</button>
                            <button style={{...styles.btnBase, ...styles.btnSecondary}} onClick={() => executeHybridSearch(`Crime Heatmap for "${location}"`, `THREAT MAP: ${location}`, 'crime', '', location)}>üìä HEATMAP</button>
                        </div>
                    </div>
                    <div style={styles.card}>
                        <label style={{fontSize:'12px', color:'#dc2626'}}>TARGET VETTING</label>
                        <input style={styles.input} value={target} onChange={e => setTarget(e.target.value)} placeholder="e.g. Cavo Tagoo" />
                        <button style={{...styles.btnBase, ...styles.btnPrimary}} onClick={() => { if(!target) return alert("TARGET REQUIRED"); executeHybridSearch(`Security Audit for "${target}" in "${location}"`, `TARGET: ${target}`, 'hotel', target, location); }}>üïµÔ∏è DEEP SCAN</button>
                    </div>
                </div>
            );
        };

        // --- RED TEAM (Hybrid V6.4) ---
        const RedTeam = () => {
            const [scenario, setScenario] = useState("");
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [contacts] = useStickyState({ geminiKey: "" }, 'sentinel_contacts');

            const threatLibrary = {
                vehicle: { trigger: ['car', 'drive', 'vehicle', 'route'], text: "THREATS:\n‚Ä¢ Ambush at Choke Points\n‚Ä¢ Box-in maneuver\n\nCOUNTERMEASURES:\n‚Ä¢ Vary routes\n‚Ä¢ Maintain distance" },
                hotel: { trigger: ['hotel', 'room', 'lobby', 'villa'], text: "THREATS:\n‚Ä¢ Unauthorized access\n‚Ä¢ Hidden surveillance\n\nCOUNTERMEASURES:\n‚Ä¢ Room sweep\n‚Ä¢ Pre-planned evac route" },
                crowd: { trigger: ['crowd', 'club', 'street'], text: "THREATS:\n‚Ä¢ Lone Wolf Attacker\n‚Ä¢ Separation\n\nCOUNTERMEASURES:\n‚Ä¢ Tight Diamond Formation\n‚Ä¢ Scan hands/waistbands" },
                default: { trigger: [], text: "STANDARD OPS:\n‚Ä¢ Surveillance detection\n‚Ä¢ Medical Emergency\n\nACTIONS:\n‚Ä¢ 360 awareness\n‚Ä¢ Verify comms" }
            };

            const getManualAnalysis = (text) => {
                const lower = text.toLowerCase();
                let analysis = "‚ö†Ô∏è MANUAL MODE (AI OFFLINE)\n\n";
                let matched = false;
                Object.keys(threatLibrary).forEach(key => {
                    if (key === 'default') return;
                    if (threatLibrary[key].trigger.some(t => lower.includes(t))) { analysis += `--- ${key.toUpperCase()} ---\n${threatLibrary[key].text}\n\n`; matched = true; }
                });
                return matched ? analysis : analysis + threatLibrary.default.text;
            };

            const analyze = async () => {
                setLoading(true);
                let aiSuccess = false;
                if (contacts.geminiKey) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${contacts.geminiKey}`, {
                            method: 'POST', headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ contents: [{ parts: [{ text: `Role: Red Team. Scenario: "${scenario}". List 3 threats & 3 countermeasures.` }] }] })
                        });
                        if (!res.ok) throw new Error("API Fail");
                        const data = await res.json();
                        setResult(data.candidates?.[0]?.content?.parts?.[0]?.text);
                        aiSuccess = true;
                    } catch (e) { console.warn("AI Fail"); }
                }
                if (!aiSuccess) setResult(getManualAnalysis(scenario));
                setLoading(false);
            };

            return (
                <div style={{padding:'16px'}}>
                    <h2 style={{color: 'white', borderLeft: '4px solid #dc2626', paddingLeft:'10px'}}>‚öîÔ∏è RED TEAM</h2>
                    {result && <SummaryModal title="ASSESSMENT" content={result} loading={loading} onClose={() => setResult(null)} />}
                    {loading && <SummaryModal loading={true} />}
                    <div style={styles.card}>
                        <label style={{color: '#dc2626', fontSize: '12px'}}>SCENARIO</label>
                        <textarea style={styles.textarea} value={scenario} onChange={e => setScenario(e.target.value)} placeholder="e.g. VIP movement in rain..." />
                        <button style={{...styles.btnBase, ...styles.btnPrimary}} onClick={analyze}>ANALYZE</button>
                    </div>
                </div>
            );
        };

        // --- REPORT GEN (Shift Stack V6.4) ---
        const ReportGen = () => {
            const [mode, setMode] = useState('manual');
            const [data, setData] = useState({ time: "", loc: "", status: "ALL CLEAR", notes: "" });
            const [logs, setLogs] = useStickyState([], 'sentinel_shift_logs');
            const [report, setReport] = useState(null);
            const [aiNotes, setAiNotes] = useState("");
            const [loading, setLoading] = useState(false);
            const [contacts] = useStickyState({ geminiKey: "" }, 'sentinel_contacts');

            const addLog = () => {
                if (!data.loc && !data.notes) return alert("INFO REQUIRED");
                const now = new Date();
                const ts = data.time || now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                setLogs(prev => [...prev, { id: Date.now(), time: ts, loc: data.loc.toUpperCase(), status: data.status, notes: data.notes }]);
                setData({ time: "", loc: "", status: "ALL CLEAR", notes: "" });
            };

            const compile = () => {
                if (logs.length === 0) return alert("NO LOGS");
                let txt = `T-FORCE REPORT\nDATE: ${new Date().toLocaleDateString()}\n\n`;
                logs.sort((a,b) => a.time.localeCompare(b.time)).forEach(l => { txt += `[${l.time}] ${l.loc}\nSTATUS: ${l.status}\nNOTES: ${l.notes}\n\n`; });
                txt += `END OF SHIFT\nENTRIES: ${logs.length}`;
                setReport(txt);
            };

            const generateAI = async () => {
                if (!contacts.geminiKey) return alert("API KEY REQUIRED");
                setLoading(true);
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${contacts.geminiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Role: Bodyguard. Format as Log. Notes: "${aiNotes}"` }] }] })
                    });
                    if (!res.ok) throw new Error("API Fail");
                    const d = await res.json();
                    setReport(d.candidates?.[0]?.content?.parts?.[0]?.text);
                } catch (e) { setReport("AI FAILED. USE MANUAL LOG."); } 
                finally { setLoading(false); }
            };

            return (
                <div style={{padding:'16px'}}>
                    <h2 style={{color: 'white', borderLeft: '4px solid #dc2626', paddingLeft:'10px'}}>üìù REPORT</h2>
                    {report && <SummaryModal title="REPORT" content={report} loading={loading} onClose={() => setReport(null)} />}
                    {loading && <SummaryModal loading={true} />}
                    <div style={{display:'flex', gap:'10px', marginBottom:'10px'}}>
                        <button style={{...styles.btnBase, backgroundColor: mode==='manual'?'#dc2626':'#333', fontSize:'14px'}} onClick={()=>setMode('manual')}>MANUAL</button>
                        <button style={{...styles.btnBase, backgroundColor: mode==='ai'?'#dc2626':'#333', fontSize:'14px'}} onClick={()=>setMode('ai')}>AI</button>
                    </div>
                    {mode === 'ai' ? (
                        <div style={styles.card}>
                            <textarea style={styles.textarea} value={aiNotes} onChange={e => setAiNotes(e.target.value)} placeholder="Rough notes..." />
                            <button style={{...styles.btnBase, ...styles.btnPrimary}} onClick={generateAI}>GENERATE (AI)</button>
                        </div>
                    ) : (
                        <div>
                            <div style={styles.card}>
                                <div style={{display:'flex', gap:'10px'}}>
                                    <input style={{...styles.input, flex:1}} value={data.time} onChange={e => setData({...data, time: e.target.value})} placeholder="Time" />
                                    <input style={{...styles.input, flex:2}} value={data.loc} onChange={e => setData({...data, loc: e.target.value})} placeholder="Location" />
                                </div>
                                <select style={styles.input} value={data.status} onChange={e => setData({...data, status: e.target.value})}>
                                    <option>ALL CLEAR</option><option>SUSPICIOUS</option><option>INCIDENT</option><option>MOVEMENT</option>
                                </select>
                                <textarea style={{...styles.textarea, minHeight:'60px'}} value={data.notes} onChange={e => setData({...data, notes: e.target.value})} placeholder="Details..." />
                                <button style={{...styles.btnBase, ...styles.btnPrimary, marginBottom:0}} onClick={addLog}>+ LOG ENTRY</button>
                            </div>
                            {logs.length > 0 && (
                                <div style={{marginTop:'20px'}}>
                                    <div style={{display:'flex', justifyContent:'space-between', color:'#999', fontSize:'12px'}}><span>LOGS ({logs.length})</span><span onClick={()=>confirm("Clear?")&&setLogs([])} style={{color:'#dc2626'}}>CLEAR</span></div>
                                    <div style={{maxHeight:'200px', overflowY:'auto', border:'1px solid #333', padding:'10px', backgroundColor:'#000'}}>
                                        {logs.map(l => <div key={l.id} style={{borderBottom:'1px solid #333', marginBottom:'5px', fontSize:'12px'}}><span style={{color:'#dc2626'}}>{l.time}</span> {l.loc} <div style={{color:'#999'}}>{l.notes||l.status}</div></div>)}
                                    </div>
                                    <button style={{...styles.btnBase, ...styles.btnSecondary, marginTop:'10px'}} onClick={compile}>üìÑ COMPILE SHIFT</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- DASHBOARD (Reorganized) ---
        const Dashboard = ({ setView, onLogout, user }) => {
            const [broadcasting, setBroadcasting] = useState(false);
            const watchId = useRef(null);

            const toggleBroadcast = () => {
                if (broadcasting) {
                    navigator.geolocation.clearWatch(watchId.current);
                    setBroadcasting(false);
                } else {
                    watchId.current = navigator.geolocation.watchPosition(pos => {
                        const { doc, setDoc, serverTimestamp } = window.fbFunctions;
                        setDoc(doc(window.fbDb, 'locations', user.uid), {
                            latitude: pos.coords.latitude, longitude: pos.coords.longitude,
                            username: user.email, timestamp: serverTimestamp(), onDuty: true
                        }, {merge: true});
                    });
                    setBroadcasting(true);
                }
            };

            return (
                <div style={{padding:'16px'}}>
                    <div style={{...styles.card, borderLeft:'6px solid #dc2626', display:'flex', justifyContent:'space-between', alignItems:'center'}}>
                        <div><h2 style={{margin:0, fontSize:'24px'}}>COMMAND</h2><small style={{color: broadcasting ? '#22c55e' : '#666', fontWeight:'bold'}}>{broadcasting ? "‚óè BROADCASTING" : "‚óã OFF DUTY"}</small></div>
                        <button onClick={toggleBroadcast} style={{padding:'8px', backgroundColor: broadcasting ? '#22c55e' : '#333', border:'none', borderRadius:'4px', color:'white', fontWeight:'bold'}}>{broadcasting ? "STOP" : "GO LIVE"}</button>
                    </div>

                    <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:'10px', marginBottom:'10px'}}>
                        <button style={{...styles.btnBase, ...styles.btnSecondary, flexDirection:'column', height:'90px'}} onClick={() => setView('intel')}><span>üîé</span> INTEL</button>
                        <button style={{...styles.btnBase, ...styles.btnSecondary, flexDirection:'column', height:'90px'}} onClick={() => setView('scanner')}><span>üì∑</span> SCAN</button>
                        <button style={{...styles.btnBase, ...styles.btnSecondary, flexDirection:'column', height:'90px'}} onClick={() => setView('gear')}><span>üéí</span> GEAR</button>
                        <button style={{...styles.btnBase, ...styles.btnSecondary, flexDirection:'column', height:'90px'}} onClick={() => setView('report')}><span>üìù</span> REPORT</button>
                        <button style={{...styles.btnBase, ...styles.btnSecondary, flexDirection:'column', height:'90px'}} onClick={() => setView('redteam')}><span>‚öîÔ∏è</span> RED TEAM</button>
                        <button style={{...styles.btnBase, ...styles.btnPrimary, flexDirection:'column', height:'90px'}} onClick={() => setView('evac')}><span>üß≠</span> EVAC</button>
                    </div>
                    
                    <button style={{...styles.btnBase, backgroundColor:'#333', fontSize:'12px'}} onClick={onLogout}>LOGOUT</button>
                </div>
            );
        };

        // --- CRISIS, GEAR, SETTINGS (Standard) ---
        const GearChecklist = () => { const [active, setActive] = useState(null); const [checks, setChecks] = useStickyState({}, 'gear'); const toggle = (id) => setChecks(p => ({...p, [id]: !p[id]})); const lists = { club: {t:"NIGHT CLUB", i:["Comms", "Strobe", "Armor", "IFAK"]}, villa: {t:"VILLA", i:["Keys", "Codes", "Torch", "CCTV"]}, factory: {t:"FACTORY", i:["Vest", "Helmet", "Boots", "Log"]}, vip: {t:"VIP", i:["Go Bag", "Meds", "Blanket", "Maps"]} }; return active ? <div style={{padding:'16px'}}><button style={{...styles.btnBase, ...styles.btnSecondary}} onClick={()=>setActive(null)}>BACK</button><h2 style={{color:'white'}}>{lists[active].t}</h2>{lists[active].i.map((item,i)=><div key={i} onClick={()=>toggle(`${active}-${i}`)} style={{...styles.card, opacity: checks[`${active}-${i}`]?0.4:1, border: checks[`${active}-${i}`]?'1px solid #333':'1px solid #dc2626'}}>{item} {checks[`${active}-${i}`]&&'‚úì'}</div>)}</div> : <div style={{padding:'16px'}}><h2 style={{color:'white'}}>GEAR</h2>{Object.entries(lists).map(([k,v])=><button key={k} style={{...styles.btnBase, ...styles.btnSecondary}} onClick={()=>setActive(k)}>{v.t}</button>)}</div>; };
        const EvacMap = () => { const [coords, setCoords] = useState(null); useEffect(() => { if ("geolocation" in navigator) navigator.geolocation.getCurrentPosition(p => setCoords({lat: p.coords.latitude.toFixed(5), lng: p.coords.longitude.toFixed(5)})); }, []); const routeTo = (dest) => window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(dest)}&travelmode=driving`, '_blank'); return (<div style={{ padding: '16px' }}><h2 style={{color:'white'}}>EVAC</h2><div style={styles.card}>{coords ? `${coords.lat}, ${coords.lng}` : "LOCATING..."}</div><button style={{...styles.btnBase, ...styles.btnPrimary}} onClick={() => routeTo('hospital')}>üè• HOSPITAL</button><button style={{...styles.btnBase, ...styles.btnPrimary}} onClick={() => routeTo('police station')}>üëÆ POLICE</button></div>); };
        const CrisisMode = () => { const [mode, setMode] = useState(null); const [contacts] = useStickyState({ police: "100", ambulance: "166" }, 'contacts'); const p = { medical: {t:"MEDICAL", s:["SECURE", "TRIAGE", "EMS"], c:contacts.ambulance}, arrest: {t:"ARREST", s:["SILENCE", "LAWYER"], c:contacts.fixer}, attack: {t:"ATTACK", s:["COVER", "FIRE", "EVAC"], c:contacts.police} }; return mode ? <div style={{padding:'16px'}}><button style={{...styles.btnBase, ...styles.btnSecondary}} onClick={()=>setMode(null)}>BACK</button><div style={{...styles.card, background:'#3f0000', textAlign:'center'}}><h1>{mode}</h1></div>{p[mode].s.map(s=><div style={{...styles.card}}>{s}</div>)}<a href={`tel:${p[mode].c}`} style={{...styles.btnBase, background:'#22c55e', textDecoration:'none', color:'black'}}>CALL</a></div> : <div style={{padding:'16px'}}><h2 style={{color:'#dc2626'}}>CRISIS</h2><button style={{...styles.btnBase, ...styles.btnDanger}} onClick={()=>setMode('medical')}>MEDICAL</button><button style={{...styles.btnBase, background:'#333', color:'white', border:'1px solid white'}} onClick={()=>setMode('attack')}>ATTACK</button><button style={{...styles.btnBase, background:'#d97706', color:'black'}} onClick={()=>setMode('arrest')}>ARREST</button></div>; };
        
        // --- NEW: SECURE SETTINGS MODULE ---
        const Settings = ({ close }) => {
            const [contacts, setContacts] = useStickyState({ police: "100", ambulance: "166", embassy: "", geminiKey: "" }, 'sentinel_contacts');
            const [showKey, setShowKey] = useState(false);
            const handleChg = (key, val) => setContacts(p => ({...p, [key]: val}));
            const panicWipe = () => { if(window.confirm("CONFIRM: WIPE ALL DATA?")) { localStorage.clear(); window.location.reload(); } };
            
            const hasKey = contacts.geminiKey && contacts.geminiKey.length > 5;

            return (
                <div style={{padding:'16px'}}>
                    <h3>CONFIGURATION</h3>
                    <div style={styles.card}>
                        <label style={{fontSize:'12px', color:'#dc2626', fontWeight:'bold'}}>AI UPLINK STATUS</label>
                        {!showKey && hasKey ? (
                            <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', padding:'10px', backgroundColor:'#000', border:'1px solid #22c55e', borderRadius:'2px', marginBottom:'12px'}}>
                                <span style={{color:'#22c55e', fontWeight:'bold'}}>‚óè SYSTEM ONLINE</span>
                                <button style={{background:'none', border:'none', color:'#666', fontSize:'10px', textDecoration:'underline'}} onClick={() => setShowKey(true)}>CHANGE KEY</button>
                            </div>
                        ) : (
                            <div style={{marginBottom:'12px'}}>
                                <input style={{...styles.input, borderColor: '#dc2626'}} type="password" value={contacts.geminiKey} onChange={e => handleChg('geminiKey', e.target.value)} placeholder="ENTER API KEY" />
                                {hasKey && <button style={{fontSize:'10px', color:'#999', background:'none', border:'none', marginTop:'5px'}} onClick={() => setShowKey(false)}>CANCEL EDIT</button>}
                            </div>
                        )}
                        <label style={{fontSize:'12px', color:'#999'}}>POLICE</label>
                        <input style={styles.input} value={contacts.police} onChange={e => handleChg('police', e.target.value)} />
                        <label style={{fontSize:'12px', color:'#999'}}>AMBULANCE</label>
                        <input style={styles.input} value={contacts.ambulance} onChange={e => handleChg('ambulance', e.target.value)} />
                        <label style={{fontSize:'12px', color:'#999'}}>EMBASSY</label>
                        <input style={styles.input} value={contacts.embassy} onChange={e => handleChg('embassy', e.target.value)} />
                    </div>
                    <button style={{...styles.btnBase, ...styles.btnPrimary}} onClick={close}>üíæ SAVE CONFIG</button>
                    <div style={{marginTop: '30px', borderTop:'1px solid #333', paddingTop:'20px'}}> <button style={{...styles.btnBase, backgroundColor: 'transparent', border:'2px solid #dc2626', color:'#dc2626'}} onClick={panicWipe}>‚ò¢Ô∏è PANIC WIPE</button> </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [view, setView] = useState('dashboard');
            const [user, setUser] = useState(null);
            const [fbReady, setFbReady] = useState(false);

            useEffect(() => {
                const initListener = () => { setFbReady(true); window.fbFunctions.onAuthStateChanged(window.fbAuth, u => setUser(u)); };
                window.addEventListener('firebase-ready', initListener);
                if(window.fbAuth) initListener();
                return () => window.removeEventListener('firebase-ready', initListener);
            }, []);

            if (!fbReady) return <div style={{...styles.app, display:'flex', justifyContent:'center', alignItems:'center'}}>INITIALIZING...</div>;
            if (!user) return <AuthScreen />;

            return (
                <div style={styles.app}>
                    <Header setView={setView} />
                    {view === 'dashboard' && <Dashboard setView={setView} user={user} onLogout={()=>window.fbFunctions.signOut(window.fbAuth)} />}
                    {view === 'intel' && <IntelHub />}
                    {view === 'scanner' && <QRScanner />}
                    {view === 'gear' && <GearChecklist />}
                    {view === 'report' && <ReportGen />}
                    {view === 'redteam' && <RedTeam />}
                    {view === 'evac' && <EvacMap />}
                    {view === 'crisis' && <CrisisMode />}
                    {view === 'settings' && <Settings close={() => setView('dashboard')} />}
                    
                    <div style={styles.nav}>
                        <button style={{...styles.navItem, color: view==='dashboard'?'#dc2626':'#6b7280'}} onClick={() => setView('dashboard')}><span style={{fontSize:'20px'}}>üè†</span></button>
                        <button style={{...styles.navItem, color: view==='evac'?'#dc2626':'#6b7280'}} onClick={() => setView('evac')}><span style={{fontSize:'20px'}}>üß≠</span></button>
                        <div style={{position:'relative', top:'-25px'}}><button onClick={() => setView('crisis')} style={{width:'64px', height:'64px', borderRadius:'50%', border:'4px solid #000', backgroundColor:'#dc2626', color:'white', fontSize:'28px', display:'flex', alignItems:'center', justifyContent:'center', boxShadow:'0 0 15px rgba(220, 38, 38, 0.4)'}}>üö®</button></div>
                        <button style={{...styles.navItem, color: view==='intel'?'#dc2626':'#6b7280'}} onClick={() => setView('intel')}><span style={{fontSize:'20px'}}>üîé</span></button>
                        <button style={{...styles.navItem, color: view==='scanner'?'#dc2626':'#6b7280'}} onClick={() => setView('scanner')}><span style={{fontSize:'20px'}}>üì∑</span></button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
